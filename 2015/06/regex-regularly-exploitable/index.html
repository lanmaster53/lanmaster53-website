<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>lanmaster53.com</title>
        <meta name="author" content="Tim Tomes">
        <meta name="description" content="Articles, information, and projects related to development and web application security.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" type="text/css">
        <link rel="stylesheet" href="/static/css/normalize.css">
        <link rel="stylesheet" href="/static/css/skeleton.css">
        <link rel="stylesheet" href="/static/css/style.css">
        <link rel="stylesheet" href="/static/css/pygments.css">
        <link rel="shortcut icon" href="https://www.gravatar.com/avatar/0a6d9b1ad59ad436bf9d9d16b2a7133e.png?s=16" />
    </head>
    <body>
        <div class="container">
            <div class="row">
                <div class="four columns meta">
                    <ul>
                        <li><a href="/"><img src="https://www.gravatar.com/avatar/0a6d9b1ad59ad436bf9d9d16b2a7133e.png?s=128" class="avatar" /></a></li>
                                            <li><a href="https://bitbucket.org/lanmaster53" target="_blank"><img src="/static/images/meta/bitbucket.png" /></a></li>
                                            <li><a href="https://github.com/lanmaster53" target="_blank"><img src="/static/images/meta/github.png" /></a></li>
                                            <li><a href="https://twitter.com/lanmaster53" target="_blank"><img src="/static/images/meta/twitter.png" /></a></li>
                                            <li><a href="https://www.linkedin.com/in/lanmaster53" target="_blank"><img src="/static/images/meta/linkedin.png" /></a></li>
                                            <li><a href="https://www.youtube.com/user/lanmaster53" target="_blank"><img src="/static/images/meta/youtube.png" /></a></li>
                                        </ul>
                </div>
                <div class="eight columns nav">
                    <ul>
                        <li><a href="https://www.practisec.com/"><span style="font-weight: bold; color: #00b5ef;">Practi</span><span style="font-weight: bold; color: #1e1b1d;">Sec</span></a> | </li>
                                            <li><a href="/projects/">Projects</a> | </li>
                                            <li><a href="/archive/">Archive</a> | </li>
                                            <li><a href="/categories/">Categories</a> | </li>
                                            <li><a href="/about/">About</a></li>
                                        </ul>
                </div>
            </div>
            <!-- hr style="margin-top: 0;" -->
            <div class="row">
                <div class="twelve columns">
                    <h2>Regex: Regularly Exploitable</h2>
<h5>Thursday, June 11, 2015</h5>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="twelve columns">
                    <div class="content">
    <p>Here's a quick demonstration of why Regular Expressions (regex) can be bad for implementing character whitelisting.</p>
<!-- READMORE -->

<p>I was reading through an application security assessment report recently and noticed a recommendation for preventing Operating System Command Injection (OSCI) that implemented character whitelisting on a given file name through the following regex.</p>
<div class="codehilite"><pre><span></span><code>/^[\/a-zA-Z0-9\-\s_]+\.rpt$/m
</code></pre></div>

<p>At first glance, the regex seems legit, right? It attempts to match any combination of letters, numbers, dashes, underscores, slashes, and whitespace, ending with the ".rpt" extension. Already knowing that there was a flaw here (we'll get to that in a moment), I put together the following proof-of-concept to demonstrate the security (or in-security) of the filter.</p>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;?php</span>
<span class="nv">$file_name</span> <span class="o">=</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">];</span>
<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">preg_match</span><span class="p">(</span><span class="s2">&quot;/^[\/a-zA-Z0-9\-\s_]+\.rpt$/m&quot;</span><span class="p">,</span> <span class="nv">$file_name</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="s2">&quot;regex failed&quot;</span><span class="p">;</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">echo</span> <span class="nb">exec</span><span class="p">(</span><span class="s2">&quot;/usr/bin/file -i -b &quot;</span> <span class="o">.</span> <span class="nv">$file_name</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div>

<p>I tried all the typical attack payloads, and sure enough, the regex prevented injection into the shell command. The key here, and why one must always use caution when implementing regex filters, is understanding what the <code>\s</code> character class represents. Most resources are vague and say that it includes "any whitespace character", but what does that include? In most regex implementations, whitespace includes <code>[ \t\r\n\f]</code>, i.e. spaces, tabs, line breaks, and form feeds. See the problem yet?</p>
<p>Many testers don't think about the impact of line breaks when dealing with injections, but when we're dealing with shell commands, line breaks become very important. Consider the following attack payload.</p>
<div class="codehilite"><pre><span></span><code>/path/to/file%0Aid%0A.rpt
</code></pre></div>

<p><code>%0a</code> is a URL encoded line feed/break (whitespace), so according to the regex, this payload is safe. However, what happens when you put this into a shell? Below is the output from copying and pasting the decoded version of the above payload into a terminal prompt.</p>
<div class="codehilite"><pre><span></span><code># /usr/bin/file -i -b /path/to/file
ERROR: cannot open `/path/to/file&#39; (No such file or directory)
# id
uid=0(root) gid=0(root) groups=0(root)
# .rpt
bash: .rpt: command not found
# 
</code></pre></div>

<p>Do you see what happened? Each line break started a new command and we can see that the shell executed our arbitrary <code>id</code> command. Here's what it looks like through a web interface.</p>
<p><a href="/static/images/posts/regex_wl_1.png"><img alt="" src="/static/images/posts/regex_wl_1.png" /></a></p>
<p>So let's fix this. Show of hands for how many people think the below regex solves the injection issue? (I replaced the <code>\s</code> with a space <code></code>.)</p>
<div class="codehilite"><pre><span></span><code>/^[\/a-zA-Z0-9\- _]+\.rpt$/m
</code></pre></div>

<p>If we use the same payloads as before, including the one that resulted in a successful injection, we can see that the issue has been resolved.</p>
<p><a href="/static/images/posts/regex_wl_2.png"><img alt="" src="/static/images/posts/regex_wl_2.png" /></a></p>
<p>Or has it? Consider the following attack payload.</p>
<div class="codehilite"><pre><span></span><code>/path/to/file.rpt%0aid
</code></pre></div>

<p><a href="/static/images/posts/regex_wl_3.png"><img alt="" src="/static/images/posts/regex_wl_3.png" /></a></p>
<p>What just happened?! Let's look at the new regex again.</p>
<div class="codehilite"><pre><span></span><code>/^[\/a-zA-Z0-9\- _]+\.rpt$/m
</code></pre></div>

<p>See that <code>m</code> at the end of the regex pattern? It means something. At the end of the regex pattern declaration in PHP (available in other frameworks as well, but may be declared differently) there is a spot for modifiers. Regex modifiers change how the regex engine applies the pattern to the string. Discussing the different regex modifiers is outside the scope of this article, but what we want to focus on here is that the filter pattern is using the multiline modifier (<code>m</code> is the flag for multiline). The multiline modifier basically changes the way the beginning (<code>^</code>) and end (<code>$</code>) of line characters behave. When the multiline modifier is absent, the <code>^</code> and <code>$</code> characters act as the beginning and end of the <strong>string</strong>, as opposed to the <strong>line</strong>. This is an important distinction, because in the payload, we are able to leverage the multiline modifier's effect on the <code>$</code> character and a line break to create a match. We can then add anything we want to the end of the string to execute arbitrary commands within the shell.</p>
<p>There are a couple of takeaways here.</p>
<p>First, be mindful of how you build whitelists. Be as explicit as possible. The higher the level of whitelist, the better. For instance, in the above example, the optimal solution would be to build a whitelist of complete file names that are allowed, and ignore regex all together. If the file names are not known and we need to whitelist at the character level, then we would need to build a better regex that accounts for what is included in all allowed character classes within the context of the filter, e.g. <code>%0a</code> and its significance to shell commands and the multiline modifier.</p>
<p>Second, Burp was not able to find this vulnerability when the scanner speed was set to <code>Normal</code> (default). It wasn't until I set the scanner speed to <code>Thorough</code> and hard coded the ".rpt" extension into the payload that Burp was able to find it. There is no replacement for thorough manual testing by someone that knows what they're doing.</p>
<p>A shout out to <a href="https://twitter.com/forced_request">John Poulin</a>, who taught me a thing or two about exploiting regex that ultimately lead to this article. Thanks John. </p>
</div>
<p>Like what you see? Join me for live training! See the <a href="https://www.practisec.com/training/">Training</a> page for more information.</p>
<hr>
<div class="comments">
    <h6>Please share your thoughts, comments, and suggestions via Twitter.</h6>
    <a href="http://twitter.com/share" class="twitter-share-button" data-count="none" data-via="">Tweet</a>
    <a href="http://twitter.com/lanmaster53" class="twitter-follow-button" data-show-count="false">Follow @lanmaster53</a>
    <script src="https://platform.twitter.com/widgets.js" type="text/javascript"></script>
</div>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="twelve columns">
                    <footer>
                        <p style="float: right;">
                            &copy; 2025 Tim Tomes
                        </p>
                    </footer>
                </div>
            </div>
        </div>
        <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-52269615-1', 'lanmaster53.com');
    ga('send', 'pageview');
</script>    </body>
</html>